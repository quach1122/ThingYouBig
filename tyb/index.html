<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <style>
  .modal-header, h4, .close {
      background-color: #5cb85c;
      color:white !important;
      text-align: center;
      font-size: 30px;
  }
  .modal-footer {
      background-color: #f9f9f9;
  }
  .block {
    display: block;
  }
  .display-score {
    line-height: 34px;
  }
  .container label {
    font-family: Sans-serif;
    color: #808080;
  }
  #dashboard {
    display: inline-block;
    white-space: nowrap;

  }
  #dashboard .row {
    margin: 15px 0;
  }
  .history-user h1 {
    margin: 0 20px;
  }
  .history-user, #history-dashboard {
    vertical-align: top;
    display: inline-block;
  }
  #history-dashboard {
    white-space: nowrap;
  }
  #history-dashboard > div{
    display: inline-block;
  }
  .points-cell {
    text-align: center;
  }
  .points-cell span {
    padding: 0 5px;
  }
  .container h2 {
    display: inline-block;
    vertical-align: middle;
  }
  .container {
    text-align: center;
  }
  .container form {
    text-align: left;
  }
  #resetGame {
    display: inline-block;
    vertical-align: text-top;
  }
  .vert-btm {
    vertical-align: bottom;
  }
  </style>
</head>
<body>
<div class="container">
    <div>
        <h2>Think You Big</h2>    
        <button type="button" class="btn btn-danger" id="resetGame">Reset</button>
    </div>
  <section id="dashboard">
  </section>
  <section id="history-dashboard">
      
  </section>
  <!-- Modal -->
  <div class="modal fade" id="modalReset" role="dialog">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Reset Game</h4>
        </div>
        <div class="modal-body">
          <p>Are you sure?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" id="resetConfirm">yes</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalStart" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header" style="padding:35px 50px;">
         <h4><span class="glyphicon glyphicon-user"></span> Add Users</h4>
        </div>
        <div class="modal-body" style="padding:40px 50px;">
          <form novalidate>
            <div class="form-group">
              <label></span>User 1</label>
              <input type="text" name="user1" class="form-control user1">
            </div>
            <div class="form-group">
              <label></span>User 2</label>
              <input type="text" name="user2" class="form-control user2">
            </div>
            <div class="form-group">
              <label></span>User 3</label>
              <input type="text" name="user3" class="form-control user3">
            </div>
            <div class="form-group">
              <label></span>User 4</label>
              <input type="text" name="user4" class="form-control user4">
            </div>
            <div class="form-group">
              <label></span>Points</label>
              <input type="text" class="form-control points">
            </div>
            <button id="startGame" class="btn btn-success btn-block">
                <span class="glyphicon glyphicon-off"></span>
                Start Game
            </button>
          </form>
        </div>
        <div class="modal-footer"></div>
      </div>
    </div>
  </div> 
</div>
<script>
$(document).ready(function(){
    let points = 0;
    let scores = {};
    let listOfUsers = [];
    let history = [];
    const SINGLE = 1,
        DOUBLE = 2,
        TRIPLE = 3,
        QUAD = 4;
    const hasLocalStorage = JSON.parse(localStorage.getItem("tyb-data"));
    
    if(hasLocalStorage){
        points = hasLocalStorage.points;
        listOfUsers = hasLocalStorage.listOfUsers;
        scores = hasLocalStorage.scores;
        history = hasLocalStorage.history;
        console.log(points, listOfUsers, scores);
               listOfUsers.forEach(data => {
        const user =`<div class="form-group row user-row">
                        <label class="col-form-label block">${data}</label>
                        <div class="col-xs-12 col-sm-12" style="padding-left: 0;">
                            <input class="form-control" type="text">
                        </div>
                    </div>`;
                $('#dashboard').append(user);
        });
        listOfUsers.forEach(data => {
            const historyUser = `<div class="history-user" data-history-name=${data.toUpperCase()}>
                    <h1>${data.toUpperCase()}</h1>    
                </div>`
            $('#history-dashboard').append(historyUser);
        });
        for(var i = 0; i < history.length; i++){
            for(var j = 0; j < listOfUsers.length; j++){
                const score = `<div class="points-cell"><span>c: ${history[i][listOfUsers[j]].c}</span><span>p: ${history[i][
                    listOfUsers[j]].p}</span></div>`
                $("[data-history-name='"+listOfUsers[j]+"']").append(score);
            }
        }
        $('#dashboard').append(`<div class="form-group row vert-btm"><div class="col-xs-12 col-sm-12" style="padding-left: 0;">
            <button type="button" id="calculate" class="btn btn-primary">Calculate</button>
            </div></div>`);
    }
    else {
        $("#modalStart").modal();
    }
    $("#startGame").click(function(e){
        e.preventDefault();
        const users = [...$("input[name^='user']")];
        if(!$('.points').val()){
            return;
        }
        points = $('.points').val()
        users.forEach(data => {
        const user =`<div class="form-group row user-row">
                        <label class="col-form-label block">${$(data).val().toUpperCase()}</label>
                        <div class="col-xs-12 col-sm-12" style="padding-left: 0;">
                            <input class="form-control" type="text">
                        </div>
                    </div>`;
            if($(data).val()){
                scores[$(data).val().toUpperCase()] = 0;
                listOfUsers.push($(data).val().toUpperCase());
                $('#dashboard').append(user);
            }
        });
        $('#dashboard').append(`<div class="form-group row vert-btm"><div class="col-xs-12 col-sm-12" style="padding-left: 0;">
            <button type="button" id="calculate" class="btn btn-primary">Calculate</button>
            </div></div>`);
        users.forEach(data => {
            const historyUser = `<div class="history-user" data-history-name=${$(data).val().toUpperCase()}>
                    <h1>${$(data).val().toUpperCase()}</h1>    
                </div>`
            if($(data).val()){
                $('#history-dashboard').append(historyUser);
            }
        });
        $('#modalStart').modal('hide');
    });
    $("#resetGame").click(function(e){
        $("#modalReset").modal();
    });
    $("#resetConfirm").click(function(e){
        $('#modalReset').modal('hide');
        points = 0;
        scores = {};
        listOfUsers = [];
        history = [];
        $("#history-dashboard").empty();
        $("#dashboard").empty();
        localStorage.removeItem("tyb-data");
        $('#modalStart').modal();
    })
    $(document.body).on('click', "#calculate", function(e){
        const tempUser = {},
            tempPoints = {};
            console.log(e.target);
        [...$(".user-row")].forEach(data => {
            tempUser[$(data).find('label').text()] = $(data).find('input').val();
        })

        const sortTopToBottom = Object.keys(tempUser).sort(function(a,b){return Number(tempUser[a])-Number(tempUser[b])})
        for(var i = 0; i < sortTopToBottom.length; i++){
            for(var j = i+1; j < sortTopToBottom.length; j++){
                let userVal = Number(tempUser[sortTopToBottom[j]]) * Number(points);
                if(i === 0) { // first winner
                    if(userVal < (7*points)){
                        scores[sortTopToBottom[i]] += (userVal * SINGLE);
                        scores[sortTopToBottom[j]] += -(userVal * SINGLE);
                    }
                    else if(userVal >= (7*points) && userVal <= (10*points)){
                        scores[sortTopToBottom[i]] += (userVal * DOUBLE);
                        scores[sortTopToBottom[j]] += -(userVal * DOUBLE);
                    }
                    else if(userVal >= (11*points) && userVal <= (12*points)){
                        scores[sortTopToBottom[i]] += (userVal * TRIPLE);
                        scores[sortTopToBottom[j]] += -(userVal * TRIPLE);
                    }
                    else if(userVal === (13*points)) {
                        scores[sortTopToBottom[i]] += (userVal * QUAD);
                        scores[sortTopToBottom[j]] += -(userVal * QUAD);
                    }
                }
                else {
                    scores[sortTopToBottom[i]] += (userVal - (Number(tempUser[sortTopToBottom[i]]) * points));
                    scores[sortTopToBottom[j]] += -(userVal - (Number(tempUser[sortTopToBottom[i]]) * points));
                }
            }
        }
        [...$(".history-user")].forEach(data => {
            const name = $(data).data("history-name");

            const score = `<div class="points-cell"><span>c: ${tempUser[name]}</span><span>p: ${scores[name]}</span></div>`
                $(data).append(score);
                tempPoints[name] = {
                        c: tempUser[name],
                        p: scores[name]
                };
        });
        history.push(tempPoints);
        localStorage.setItem("tyb-data", JSON.stringify({
            points,
            listOfUsers,
            scores,
            history
        }));
        $('#dashboard input').val("");
    })
});
</script>

</body>
</html>
